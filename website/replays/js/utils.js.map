{"version":3,"file":"utils.js","names":["HttpError","_Error","_inheritsLoose","message","statusCode","body","_this","call","name","Error","captureStackTrace","_assertThisInitialized","err","_wrapNativeSuper","NetRequest","uri","_proto","prototype","get","_this2","opts","arguments","length","undefined","Promise","resolve","reject","xhr","XMLHttpRequest","query","includes","Net","encodeQuery","open","method","onreadystatechange","DONE","readyState","status","responseText","statusText","setRequestHeader","send","post","Object","assign","data","urlencodedData","key","encodeURIComponent","decodeQuery","out","questionIndex","indexOf","slice","_i2","_query$split2","split","queryPart","_queryPart$split","value","decodeURIComponent","PSSubscription","observable","listener","_proto2","unsubscribe","index","subscriptions","splice","PSModel","_proto3","subscribe","subscription","push","subscribeAndRun","update","_i4","_this$subscriptions2","PSStreamModel","updates","_proto4","_i6","_this$updates2","_i8","_this$subscriptions4"],"sources":["../src/utils.ts"],"sourcesContent":["/**********************************************************************\n * Net\n *********************************************************************/\n\nexport interface PostData {\n\t[key: string]: string | number | undefined;\n}\nexport interface NetRequestOptions {\n\tmethod?: 'GET' | 'POST';\n\tbody?: string | PostData;\n\tquery?: PostData;\n}\nexport class HttpError extends Error {\n\tstatusCode?: number;\n\tbody: string;\n\tconstructor(message: string, statusCode: number | undefined, body: string) {\n\t\tsuper(message);\n\t\tthis.name = 'HttpError';\n\t\tthis.statusCode = statusCode;\n\t\tthis.body = body;\n\t\ttry {\n\t\t\t(Error as any).captureStackTrace(this, HttpError);\n\t\t} catch (err) {}\n\t}\n}\nexport class NetRequest {\n\turi: string;\n\tconstructor(uri: string) {\n\t\tthis.uri = uri;\n\t}\n\n\t/**\n\t * Makes a basic http/https request to the URI.\n\t * Returns the response data.\n\t *\n\t * Will throw if the response code isn't 200 OK.\n\t *\n\t * @param opts request opts\n\t */\n\tget(opts: NetRequestOptions = {}): Promise<string> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst xhr = new XMLHttpRequest();\n\t\t\tlet uri = this.uri;\n\t\t\tif (opts.query) {\n\t\t\t\turi += (uri.includes('?') ? '&' : '?') + Net.encodeQuery(opts.query);\n\t\t\t}\n\t\t\txhr.open(opts.method || 'GET', uri);\n\t\t\txhr.onreadystatechange = function () {\n\t\t\t\tconst DONE = 4;\n\t\t\t\tif (xhr.readyState === DONE) {\n\t\t\t\t\tif (xhr.status === 200) {\n\t\t\t\t\t\tresolve(xhr.responseText || '');\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst err = new HttpError(xhr.statusText || \"Connection error\", xhr.status, xhr.responseText);\n\t\t\t\t\treject(err);\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (opts.body) {\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\t\t\t\txhr.send(Net.encodeQuery(opts.body));\n\t\t\t} else {\n\t\t\t\txhr.send();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Makes a http/https POST request to the given link.\n\t * @param opts request opts\n\t * @param body POST body\n\t */\n\tpost(opts: Omit<NetRequestOptions, 'body'>, body: PostData | string): Promise<string>;\n\t/**\n\t * Makes a http/https POST request to the given link.\n\t * @param opts request opts\n\t */\n\tpost(opts?: NetRequestOptions): Promise<string>;\n\tpost(opts: NetRequestOptions = {}, body?: PostData | string) {\n\t\tif (!body) body = opts.body;\n\t\treturn this.get({\n\t\t\t...opts,\n\t\t\tmethod: 'POST',\n\t\t\tbody,\n\t\t});\n\t}\n}\n\nexport function Net(uri: string) {\n\treturn new NetRequest(uri);\n}\n\nNet.encodeQuery = function (data: string | PostData) {\n\tif (typeof data === 'string') return data;\n\tlet urlencodedData = '';\n\tfor (const key in data) {\n\t\tif ((data as any)[key] === undefined) continue;\n\t\tif (urlencodedData) urlencodedData += '&';\n\t\turlencodedData += encodeURIComponent(key) + '=' + encodeURIComponent((data as any)[key]);\n\t}\n\treturn urlencodedData;\n};\nNet.decodeQuery = function (query: string): {[key: string]: string} {\n\tlet out = {};\n\tconst questionIndex = query.indexOf('?');\n\tif (questionIndex >= 0) query = query.slice(questionIndex + 1);\n\tfor (const queryPart of query.split('&')) {\n\t\tconst [key, value] = queryPart.split('=');\n\t\tout[decodeURIComponent(key)] = decodeURIComponent(value || '');\n\t}\n\treturn out;\n};\n\n/**********************************************************************\n * Models\n *********************************************************************/\n\nexport class PSSubscription {\n\tobservable: PSModel | PSStreamModel<any>;\n\tlistener: (value?: any) => void;\n\tconstructor(observable: PSModel | PSStreamModel<any>, listener: (value?: any) => void) {\n\t\tthis.observable = observable;\n\t\tthis.listener = listener;\n\t}\n\tunsubscribe() {\n\t\tconst index = this.observable.subscriptions.indexOf(this);\n\t\tif (index >= 0) this.observable.subscriptions.splice(index, 1);\n\t}\n}\n\n/**\n * PS Models roughly implement the Observable spec. Not the entire\n * spec - just the parts we use. PSModel just notifies subscribers of\n * updates - a simple model for React.\n */\nexport class PSModel {\n\tsubscriptions = [] as PSSubscription[];\n\tsubscribe(listener: () => void) {\n\t\tconst subscription = new PSSubscription(this, listener);\n\t\tthis.subscriptions.push(subscription);\n\t\treturn subscription;\n\t}\n\tsubscribeAndRun(listener: () => void) {\n\t\tconst subscription = this.subscribe(listener);\n\t\tsubscription.listener();\n\t\treturn subscription;\n\t}\n\tupdate() {\n\t\tfor (const subscription of this.subscriptions) {\n\t\t\tsubscription.listener();\n\t\t}\n\t}\n}\n\n/**\n * PS Models roughly implement the Observable spec. PSStreamModel\n * streams some data out. This is very not-React, which generally\n * expects the DOM to be a pure function of state. Instead PSModels\n * which hold state, PSStreamModels give state directly to views,\n * so that the model doesn't need to hold a redundant copy of state.\n */\nexport class PSStreamModel<T = string> {\n\tsubscriptions = [] as PSSubscription[];\n\tupdates = [] as T[];\n\tsubscribe(listener: (value: T) => void) {\n\t\t// TypeScript bug\n\t\tconst subscription: PSSubscription = new PSSubscription(this, listener);\n\t\tthis.subscriptions.push(subscription);\n\t\tif (this.updates.length) {\n\t\t\tfor (const update of this.updates) {\n\t\t\t\tsubscription.listener(update);\n\t\t\t}\n\t\t\tthis.updates = [];\n\t\t}\n\t\treturn subscription;\n\t}\n\tsubscribeAndRun(listener: (value: T) => void) {\n\t\tconst subscription = this.subscribe(listener);\n\t\tsubscription.listener(null);\n\t\treturn subscription;\n\t}\n\tupdate(value: T) {\n\t\tif (!this.subscriptions.length) {\n\t\t\t// save updates for later\n\t\t\tthis.updates.push(value);\n\t\t}\n\t\tfor (const subscription of this.subscriptions) {\n\t\t\tsubscription.listener(value);\n\t\t}\n\t}\n}\n"],"mappings":"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"}